<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Incident Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Papa Parse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0b0d12; --panel:#11151c; --muted:#8ea0b6; --text:#e7edf7;
      --accent:#5ec4ff; --border:#1e2430; --chip:#141c28; --chip-on:#1e2a3d; --card:#0f131a;
      --focus:#9bd6ff;
    }
    *{ box-sizing:border-box }
    html, body { height:100%; margin:0; background:#0a0c10; color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Layout */
    .app { display:grid; grid-template-columns:minmax(0,1fr) 420px; height:100%; }
    #map { width:100%; height:100%; transition:height .2s ease; }
    .map-hidden { height:0 !important; min-height:0 !important; overflow:hidden; border-bottom:1px solid var(--border); }

    aside { background:var(--bg); border-left:1px solid var(--border); display:flex; flex-direction:column; min-height:0; }

    /* Sticky header block */
    .sidebar-header{
      position:sticky; top:0; z-index:3;
      background:linear-gradient(180deg,rgba(17,21,28,.98),rgba(17,21,28,.9));
      backdrop-filter:blur(4px);
      border-bottom:1px solid var(--border);
      padding:12px;
    }

    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand .dot{ width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 10px var(--accent); flex:0 0 auto; }
    h1{ font-size:18px; margin:0; line-height:1.2; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .lang-select{ margin-left:auto; display:flex; gap:6px; align-items:center; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:4px 8px; }
    .lang-select label{ color:#c9d4e6; font-size:12px; }
    .lang-select select{ background:#0e131a; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px 8px; outline:none; }

    /* Tabs */
    .tabbar{ display:flex; gap:6px; flex-wrap:wrap; padding:8px; border:1px solid var(--border);
      border-radius:12px; background:var(--panel); margin-top:10px;
    }
    .tabbar[role="tablist"]{ row-gap:8px; }
    .tab{
      border:1px solid var(--border); background:var(--chip); color:var(--text);
      padding:6px 10px; border-radius:999px; cursor:pointer; font-size:13px;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease; user-select:none;
    }
    .tab:hover{ transform:translateY(-1px); }
    .tab[aria-selected="true"]{ background:var(--chip-on); border-color:#2e394a; box-shadow:0 0 0 1px #2e394a inset; }
    .tab:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }

    /* Filters */
    .filters{ display:grid; gap:8px; margin-top:10px; }
    .controls{ display:flex; gap:8px; align-items:center; }
    select, input[type="search"], button.chip{
      width:100%; background:#0e131a; color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; font-size:14px;
    }
    input[type="search"]::placeholder{ color:#9fb0c6; }
    .chip-btns{ display:flex; gap:8px; }
    .chip-btns .chip{ flex:1 1 auto; cursor:pointer; }
    .chip-btns .chip:focus-visible{ outline:2px solid var(--focus); }

    .dropdown{ border:1px solid var(--border); border-radius:12px; background:var(--panel); overflow:hidden; }
    .dropdown > summary{ list-style:none; cursor:pointer; padding:10px 12px; font-size:13px; color:#cbd5e1; user-select:none; border-bottom:1px solid var(--border); }
    .dropdown > summary::-webkit-details-marker{ display:none; }
    .dropdown[open] > summary{ background:#0e131a; }
    .dropdown-body{ padding:10px; display:grid; gap:8px; }
    .cb-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:6px 12px; }
    .cb{ display:flex; gap:8px; align-items:center; font-size:12px; color:#d1d7e6; }
    .cb input{ accent-color:var(--accent); }

    .feed{ padding:12px; display:grid; gap:10px; overflow:auto; min-height:0; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; cursor:pointer; }
    .card:hover{ box-shadow:0 0 0 1px #223047 inset; }
    .card h3{ margin:0 0 6px; font-size:15px; }
    .meta{ color:var(--muted); font-size:12px; margin-bottom:8px; display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .tagpill{ font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; background:#0d141d; }

    .source a{ color:var(--accent); text-decoration:none; }
    .empty, .error, .loading{ padding:16px; border:1px dashed var(--border); border-radius:12px; color:#cbd5e1; text-align:center; }

    .tag-pin .pin{
      width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-size:16px; line-height:1; color:#fff; border:2px solid #0b0f16; box-shadow:0 2px 6px rgba(0,0,0,.5); background:#3b82f6;
    }
    .tag-pin .dot{ position:absolute; bottom:-6px; left:50%; transform:translateX(-50%); width:6px; height:6px; background:#0b0f16; border-radius:999px; }

    .footerbar{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding-top:8px; color:#9fb0c6; font-size:12px; }

    @media (max-width:980px){
      .app{ grid-template-columns:1fr; }
      aside{ border-left:none; border-top:1px solid var(--border); height:56vh; }
      #map{ height:44vh; }
      .cb-grid{ grid-template-columns:repeat(1,minmax(0,1fr)); }
      #toggleMapBtn{ display:block; }
    }
    @media (min-width:981px){
      #toggleMapBtn{ display:none; }
    }

    /* Hide old region tabs (replaced by location search) */
    #regionTabs{ display:none; }

    /* Active filter chip row */
    .active-filters{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .filter-chip{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--chip-on); border:1px solid #2e394a; border-radius:999px;
      padding:6px 10px; font-size:13px;
    }
    .filter-chip button{
      background:transparent; border:none; color:#cbd5e1; cursor:pointer; font-size:14px; line-height:1;
      padding:0 2px;
    }
    .filter-chip button:focus-visible{ outline:2px solid var(--focus); border-radius:6px; }

    /* Typeahead suggestions panel */
    .search-wrap{ position:relative; }
    .suggestions{
      position:absolute; top:100%; left:0; right:0; z-index:5;
      background:var(--panel); border:1px solid var(--border); border-top:none;
      border-radius:0 0 10px 10px; max-height:260px; overflow:auto;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .suggestion-item{
      padding:10px 12px; cursor:pointer; font-size:14px; color:#dbe5f5;
      border-top:1px solid rgba(30,36,48,.5);
    }
    .suggestion-item:hover, .suggestion-item[aria-selected="true"]{
      background:#0e131a;
    }
    .suggestion-header{
      padding:8px 12px; font-size:12px; color:#9fb0c6; background:#0e131a; position:sticky; top:0;
    }
    .suggestions[hidden]{ display:none; }
  </style>
</head>
<body>
  <div class="app" aria-label="Live Incident Map Application">
    <div id="map" role="region" aria-label="Map showing incidents"></div>

    <aside>
      <div class="sidebar-header">
        <div class="topbar">
          <div class="brand" title="Live Incident Map">
            <div class="dot" aria-hidden="true"></div>
            <h1 id="title">Live Incident Map</h1>
          </div>

          <!-- NEW: Basemap selector (English map options) -->
          <div class="lang-select">
            <label for="basemapSel">Map style</label>
            <select id="basemapSel" aria-label="Basemap selection"></select>
          </div>

          <div class="lang-select">
            <label for="langSel">Language</label>
            <select id="langSel" aria-label="Language selection">
              <option value="en">English</option>
              <option value="zh">‰∏≠Êñá</option>
              <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
              <option value="es">Espa√±ol</option>
              <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
          </div>
        </div>

        <!-- Region Tabs (hidden by CSS) -->
        <div class="tabbar" id="regionTabs" role="tablist" aria-label="Regions">
          <button class="tab" role="tab" aria-selected="true" data-key="all">All Regions</button>
          <button class="tab" role="tab" aria-selected="false" data-key="ua_ru">Ukraine / Russia</button>
          <button class="tab" role="tab" aria-selected="false" data-key="il_ps">Israel / Palestine</button>
          <button class="tab" role="tab" aria-selected="false" data-key="ve">Venezuela</button>
        </div>

        <!-- Theme Tabs -->
        <div class="tabbar" id="themeTabs" role="tablist" aria-label="Themes">
          <button class="tab" role="tab" aria-selected="true" data-theme="all">All</button>
          <button class="tab" role="tab" aria-selected="false" data-theme="politics">Politics/Geopolitics</button>
          <button class="tab" role="tab" aria-selected="false" data-theme="conflict">Conflict</button>
          <button class="tab" role="tab" aria-selected="false" data-theme="economics">Economics</button>
          <button class="tab" role="tab" aria-selected="false" data-theme="disasters">Disasters</button>
          <button class="tab" role="tab" aria-selected="false" data-theme="society">Society</button>
        </div>

        <!-- Filters -->
        <div class="filters">
          <button id="toggleMapBtn" class="chip" aria-pressed="false">üó∫Ô∏è Show/Hide Map</button>

          <!-- Active filters chip row -->
          <div id="activeFilters" class="active-filters" aria-live="polite"></div>

          <!-- Location search (custom suggestions only) -->
          <div class="search-wrap">
            <input id="search" type="search"
                   placeholder="Type a location‚Ä¶ e.g., United States, Europe, Texas, Kyiv"
                   aria-label="Search by continent / region / country / state / city / territory" />
            <div id="searchSuggestions" class="suggestions" role="listbox" hidden></div>
          </div>

          <div class="chip-btns">
            <button id="clearFilters" class="chip" title="Clear all filters">Clear filters</button>
            <button id="reloadBtn" class="chip" title="Reload data">Reload</button>
          </div>

          <details class="dropdown" id="catDropdown">
            <summary>Categories</summary>
            <div class="dropdown-body">
              <div class="cb-grid" id="categoryGrid"></div>
            </div>
          </details>

          <details class="dropdown" id="tagsDropdown">
            <summary>Tags</summary>
            <div class="dropdown-body">
              <div class="cb-grid" id="tagsGrid"></div>
            </div>
          </details>

          <div class="footerbar">
            <div id="statusText">Loading‚Ä¶</div>
            <div id="countText"></div>
          </div>
        </div>
      </div>

      <div class="feed" id="feed" role="feed" aria-live="polite"></div>
    </aside>
  </div>

  <script>
    // === Tag styles with emoji
    const TAG_STYLES={
      protest:{emoji:'‚úä',color:'#ef4444'},riot:{emoji:'ü™ì',color:'#ef4444'},strike:{emoji:'ü™ß',color:'#f59e0b'},blockade:{emoji:'‚õî',color:'#e11d48'},
      military:{emoji:'üéñÔ∏è',color:'#475569'},airstrike:{emoji:'‚úàÔ∏è',color:'#ef4444'},missile:{emoji:'üöÄ',color:'#fb923c'},explosion:{emoji:'üí•',color:'#f43f5e'},
      diplomacy:{emoji:'ü§ù',color:'#16a34a'},election:{emoji:'üó≥Ô∏è',color:'#22c55e'},corruption:{emoji:'üí∞',color:'#eab308'},
      trade:{emoji:'üßæ',color:'#38bdf8'},inflation:{emoji:'üìà',color:'#f59e0b'},banking:{emoji:'üè¶',color:'#60a5fa'},
      flood:{emoji:'üåä',color:'#0ea5e9'},earthquake:{emoji:'üåé',color:'#8b5e3c'},wildfire:{emoji:'üî•',color:'#f97316'},pandemic:{emoji:'ü¶†',color:'#84cc16'},
      education:{emoji:'üéì',color:'#6366f1'},religion:{emoji:'üõê',color:'#94a3b8'},
      storm:{emoji:'‚õàÔ∏è',color:'#38bdf8'},hurricane:{emoji:'üåÄ',color:'#38bdf8'},tornado:{emoji:'üå™Ô∏è',color:'#60a5fa'},cyclone:{emoji:'üåÄ',color:'#38bdf8'},
      drought:{emoji:'üåû',color:'#f59e0b'},heatwave:{emoji:'ü•µ',color:'#ef4444'},coldwave:{emoji:'ü•∂',color:'#60a5fa'},tsunami:{emoji:'üåä',color:'#0ea5e9'},
      landslide:{emoji:'üèîÔ∏è',color:'#8b5e3c'},volcano:{emoji:'üåã',color:'#f97316'},aftershock:{emoji:'üîÅ',color:'#8b5e3c'},
      fire:{emoji:'üî•',color:'#f97316'},building_collapse:{emoji:'üèöÔ∏è',color:'#94a3b8'},rescue:{emoji:'üÜò',color:'#ef4444'},evacuation:{emoji:'üö®',color:'#ef4444'},
      chemical_spill:{emoji:'üß™',color:'#eab308'},oil_spill:{emoji:'üõ¢Ô∏è',color:'#eab308'},gas_leak:{emoji:'üõ¢Ô∏è',color:'#eab308'},
      radiation:{emoji:'‚ò¢Ô∏è',color:'#facc15'},nuclear_accident:{emoji:'‚ò¢Ô∏è',color:'#facc15'},
      power_outage:{emoji:'üí°',color:'#f59e0b'},blackout:{emoji:'üí°',color:'#f59e0b'},telecom:{emoji:'üì∂',color:'#60a5fa'},internet:{emoji:'üåê',color:'#38bdf8'},
      censorship:{emoji:'üö´',color:'#e11d48'},cyberattack:{emoji:'üñ•Ô∏è',color:'#6366f1'},ransomware:{emoji:'üß¨',color:'#6366f1'},ddos:{emoji:'üåê',color:'#6366f1'},
      phishing:{emoji:'üé£',color:'#60a5fa'},data_breach:{emoji:'üóÑÔ∏è',color:'#94a3b8'},
      currency:{emoji:'üí±',color:'#60a5fa'},market:{emoji:'üìä',color:'#38bdf8'},sanction:{emoji:'üö´',color:'#e11d48'},policy:{emoji:'üìú',color:'#94a3b8'},
      legislation:{emoji:'‚öñÔ∏è',color:'#94a3b8'},court:{emoji:'üèõÔ∏è',color:'#94a3b8'},arrest:{emoji:'üöî',color:'#ef4444'},police:{emoji:'üëÆ',color:'#94a3b8'},
      prison:{emoji:'üèöÔ∏è',color:'#94a3b8'},money_laundering:{emoji:'üßº',color:'#eab308'},
      crime:{emoji:'üö®',color:'#ef4444'},theft:{emoji:'üß≥',color:'#eab308'},looting:{emoji:'üß∫',color:'#eab308'},shooting:{emoji:'üî´',color:'#ef4444'},
      stabbing:{emoji:'üî™',color:'#ef4444'},kidnapping:{emoji:'üßë‚Äçü§ù‚Äçüßë',color:'#ef4444'},assassination:{emoji:'üéØ',color:'#ef4444'},
      cartel:{emoji:'üíä',color:'#eab308'},gang:{emoji:'üß¢',color:'#94a3b8'},terrorism:{emoji:'‚ò†Ô∏è',color:'#ef4444'},
      ied:{emoji:'üß®',color:'#ef4444'},drone:{emoji:'üõ∏',color:'#60a5fa'},uav:{emoji:'üõ∏',color:'#60a5fa'},mortar:{emoji:'üß®',color:'#ef4444'},
      artillery:{emoji:'üß®',color:'#ef4444'},shelling:{emoji:'üß®',color:'#ef4444'},small_arms:{emoji:'üî´',color:'#ef4444'},
      armor:{emoji:'üõ°Ô∏è',color:'#475569'},naval:{emoji:'‚öì',color:'#475569'},checkpoint:{emoji:'üöß',color:'#94a3b8'},convoy:{emoji:'üöö',color:'#94a3b8'},
      aviation:{emoji:'‚úàÔ∏è',color:'#60a5fa'},airline:{emoji:'‚úàÔ∏è',color:'#60a5fa'},airport:{emoji:'üõ´',color:'#60a5fa'},
      maritime:{emoji:'üö¢',color:'#60a5fa'},port:{emoji:'‚öì',color:'#60a5fa'},shipping:{emoji:'üì¶',color:'#60a5fa'},shipping_disruption:{emoji:'üì¶',color:'#60a5fa'},
      piracy:{emoji:'üè¥‚Äç‚ò†Ô∏è',color:'#94a3b8'},hijacking:{emoji:'üõë',color:'#ef4444'},hostage:{emoji:'üßë‚Äçü§ù‚Äçüßë',color:'#ef4444'},
      road:{emoji:'üõ£Ô∏è',color:'#94a3b8'},bridge:{emoji:'üåâ',color:'#94a3b8'},rail:{emoji:'üöÜ',color:'#94a3b8'},derailment:{emoji:'üöÜ',color:'#ef4444'},
      crash:{emoji:'üí•',color:'#f43f5e'},collision:{emoji:'üí•',color:'#f43f5e'},
      energy:{emoji:'‚ö°',color:'#f59e0b'},power:{emoji:'‚ö°',color:'#f59e0b'},pipeline:{emoji:'üõ¢Ô∏è',color:'#eab308'},
      refinery:{emoji:'üè≠',color:'#eab308'},substation:{emoji:'üîå',color:'#f59e0b'},
      humanitarian:{emoji:'ü§≤',color:'#16a34a'},aid:{emoji:'üéí',color:'#16a34a'},refugee:{emoji:'üß≥',color:'#94a3b8'},migration:{emoji:'üß≠',color:'#94a3b8'},
      border:{emoji:'üß≠',color:'#94a3b8'},negotiation:{emoji:'ü´±üèª‚Äçü´≤üèΩ',color:'#16a34a'},security:{emoji:'üõ°Ô∏è',color:'#475569'},
      government:{emoji:'üèõÔ∏è',color:'#94a3b8'},announcement:{emoji:'üì¢',color:'#60a5fa'},official:{emoji:'üü¶',color:'#60a5fa'},
      investigation:{emoji:'üîé',color:'#94a3b8'},intel:{emoji:'üõ∞Ô∏è',color:'#60a5fa'},
      satellite:{emoji:'üõ∞Ô∏è',color:'#60a5fa'},space:{emoji:'üöÄ',color:'#60a5fa'},launch:{emoji:'üöÄ',color:'#60a5fa'},space_debris:{emoji:'üõ∞Ô∏è',color:'#94a3b8'}
    };
    const DEFAULT_STYLE={emoji:'üìç',color:'#3b82f6'};

    // Theme groups
    const LEGEND_GROUPS={
      politics:["protest","riot","strike","blockade","military","airstrike","missile","explosion","diplomacy","election","corruption","government","sanction","trade","negotiation","policy","security","legislation","court"],
      conflict:["protest","riot","strike","blockade","military","airstrike","missile","explosion","mortar","artillery","shelling","small_arms","armor","naval","drone","uav","ied","terrorism","checkpoint","convoy"],
      economics:["trade","inflation","banking","currency","market","sanction","energy","power","pipeline","refinery"],
      disasters:["flood","earthquake","wildfire","pandemic","storm","drought","heatwave","hurricane","tornado","cyclone","tsunami","landslide","volcano","aftershock","blizzard"],
      society:["education","religion","humanitarian","aid","migration","refugee","crime","police","arrest"]
    };

    const state={
      data:[],
      theme:'all',
      region:'all',
      query:'',
      location:'',
      activeTags:new Set(),
      activeCats:new Set(),
      lang:'en',
      lastLoaded:null,
      _pendingRegionZoom:false,
      _pendingSearchZoom:false
    };

    // Elements
    const feedEl=document.getElementById('feed');
    const tagsGrid=document.getElementById('tagsGrid');
    const categoryGrid=document.getElementById('categoryGrid');
    const statusText=document.getElementById('statusText');
    const countText=document.getElementById('countText');
    const activeFiltersEl=document.getElementById('activeFilters');

    // === Basemap options (English labels)
    const BaseLayers = {
      'Carto Light (EN)': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom:19, subdomains:'abcd',
        attribution:'&copy; OpenStreetMap contributors &copy; CARTO'
      }),
      'Carto Dark (EN)': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom:19, subdomains:'abcd',
        attribution:'&copy; OpenStreetMap contributors &copy; CARTO'
      }),
      'Carto Voyager (EN)': L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        maxZoom:19, subdomains:'abcd',
        attribution:'&copy; OpenStreetMap contributors &copy; CARTO'
      }),
      'Esri WorldGray (EN)': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
        maxZoom:19,
        attribution:'Tiles &copy; Esri ‚Äî Esri, HERE, Garmin, FAO, NOAA, USGS, &copy; OpenStreetMap contributors'
      }),
      'Esri Streets (EN)': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        maxZoom:19,
        attribution:'Tiles &copy; Esri ‚Äî Esri, HERE, Garmin, &copy; OpenStreetMap contributors'
      })
    };

    // Populate basemap UI
    const basemapSel = document.getElementById('basemapSel');
    const basemapNames = Object.keys(BaseLayers);
    basemapNames.forEach((name, idx)=>{
      const opt=document.createElement('option');
      opt.value=name; opt.textContent=name;
      if(idx===0) opt.selected=true; // default
      basemapSel.appendChild(opt);
    });

    // === Map
    const defaultBase = BaseLayers[basemapNames[0]]; // Carto Light (EN) by default
    const map=L.map('map',{
      center:[25,15], zoom:2, minZoom:2, maxZoom:16, worldCopyJump:true,
      maxBounds:[[-85,-100000],[85,100000]], maxBoundsViscosity:1.0,
      layers:[defaultBase]
    });
    let currentBase = defaultBase;

    // Basemap change handler
    basemapSel.addEventListener('change', (e)=>{
      const name=e.target.value;
      const next=BaseLayers[name];
      if(next && next!==currentBase){
        map.removeLayer(currentBase);
        next.addTo(map);
        currentBase = next;
      }
    });

    const clusters=L.markerClusterGroup({ showCoverageOnHover:false, chunkedLoading:true }).addTo(map);

    function makeIcon(tag){
      const st=TAG_STYLES[tag?.toLowerCase?.()]||DEFAULT_STYLE;
      const html=`<div class="pin" style="background:${st.color}">${st.emoji}</div><div class="dot"></div>`;
      return L.divIcon({className:'tag-pin',html,iconSize:[28,34],iconAnchor:[14,30]});
    }

    // Tabs
    function setTabsActive(listEl, button){
      [...listEl.querySelectorAll('.tab')].forEach(b=>b.setAttribute('aria-selected','false'));
      button.setAttribute('aria-selected','true');
    }
    document.getElementById('themeTabs').addEventListener('click',e=>{
      const t=e.target.closest('.tab'); if(!t) return;
      setTabsActive(document.getElementById('themeTabs'), t);
      state.theme=t.dataset.theme; render();
    });

    // ===== Location Search (grouped suggestions + robust matching)
    const searchEl=document.getElementById('search');
    const suggestionsEl=document.getElementById('searchSuggestions');

    // Static baseline so suggestions work even before CSV loads
    const CONTINENTS=['Africa','Asia','Europe','North America','South America','Oceania','Antarctica'];
    const REGIONS_BASE=[
      'Middle East','Eastern Europe','Western Europe','Northern Europe','Southern Europe',
      'Central Asia','South Asia','Southeast Asia','East Asia',
      'Caucasus','Balkans','Scandinavia','Iberia','Benelux',
      'Maghreb','Horn of Africa','Sub-Saharan Africa',
      'Latin America','Caribbean','Gulf','Levant'
    ];

    // Core states/territories lists (curated; extend as needed)
    const US_STATES=[ 'Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming','District of Columbia' ];
    const CA_PROV_TERR=[ 'Ontario','Quebec','Nova Scotia','New Brunswick','Manitoba','British Columbia','Prince Edward Island','Saskatchewan','Alberta','Newfoundland and Labrador','Northwest Territories','Yukon','Nunavut' ];
    const AU_STATES_TERR=[ 'New South Wales','Victoria','Queensland','Western Australia','South Australia','Tasmania','Australian Capital Territory','Northern Territory' ];
    const IN_STATES_UT=[ 'Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal','Andaman and Nicobar Islands','Chandigarh','Dadra and Nagar Haveli and Daman and Diu','Delhi','Jammu and Kashmir','Ladakh','Lakshadweep','Puducherry' ];
    const UK_CONSTITUENT=[ 'England','Scotland','Wales','Northern Ireland' ];

    const TYPE_ORDER={continent:0,region:1,country:2,state:3,city:4,territory:5,other:6};

    // Aliases (maps many-to-one normalized labels)
    const ALIASES = {
      'united states': ['us','usa','u.s.','u.s','america','united states of america'],
      'united kingdom': ['uk','u.k.','great britain','britain'],
      'united arab emirates': ['uae','u.a.e.'],
      'russia': ['russian federation'],
      'south korea': ['republic of korea','rok'],
      'north korea': ['dprk','democratic people\'s republic of korea'],
      'czechia': ['czech republic'],
      'palestine': ['state of palestine','palestinian territories','gaza','west bank'],
      'venezuela': ['bolivarian republic of venezuela']
    };

    let allLocationOptions = []; // {label,type}
    let aliasLookup = new Map(); // normalized alias -> normalized canonical label

    function normalize(str){
      return String(str||'')
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,' ')
        .trim()
        .replace(/\s+/g,' ');
    }
    function seedAliases(){
      aliasLookup.clear();
      for(const [canon, list] of Object.entries(ALIASES)){
        const nCanon = normalize(canon);
        aliasLookup.set(nCanon, nCanon);
        list.forEach(a=>aliasLookup.set(normalize(a), nCanon));
      }
    }

    // Build index from static + dataset (countries/capitals/states added separately)
    function buildBaseIndex(){
      const tmpMap = new Map(); // normLabel -> {label,type}
      const add = (label,type)=>{
        if(!label) return;
        const keyN = normalize(label);
        const canon = aliasLookup.get(keyN) || keyN;
        const existing = tmpMap.get(canon);
        if(!existing){
          tmpMap.set(canon,{label:label, type:type});
        }else{
          if(TYPE_ORDER[type] < TYPE_ORDER[existing.type]){
            tmpMap.set(canon,{label:label, type:type});
          }
        }
      };

      // Continents + baseline regions
      CONTINENTS.forEach(l=>add(l,'continent'));
      REGIONS_BASE.forEach(l=>add(l,'region'));

      // Dataset-derived
      state.data.forEach(i=>{
        add(i.continent,'continent');
        add(i.region,'region');
        add(i.country,'country');
        add(i.state_name,'state');
        add(i.city,'city');
      });

      // Curated states/territories
      US_STATES.forEach(s=>add(s,'state'));
      CA_PROV_TERR.forEach(s=>add(s,'state'));
      AU_STATES_TERR.forEach(s=>add(s,'state'));
      IN_STATES_UT.forEach(s=>add(s,'state'));
      UK_CONSTITUENT.forEach(s=>add(s,'state'));

      allLocationOptions = [...tmpMap.values()]
        .sort((a,b)=>{
          const t = TYPE_ORDER[a.type]-TYPE_ORDER[b.type];
          if(t!==0) return t;
          return a.label.localeCompare(b.label);
        });
    }

    // Enrich with countries + capitals from RestCountries
    async function enrichCountries(){
      try{
        const res = await fetch('https://restcountries.com/v3.1/all?fields=name,altSpellings,cca2,cca3,capital,region,subregion');
        if(!res.ok) return;
        const data = await res.json();
        const tmpMap = new Map(allLocationOptions.map(o=>[normalize(o.label), o]));

        const add = (label,type)=>{
          if(!label) return;
          const keyN = normalize(label);
          const canon = aliasLookup.get(keyN) || keyN;
          if(!tmpMap.has(canon)){
            tmpMap.set(canon,{label:label, type:type});
          }else{
            const ex = tmpMap.get(canon);
            if(TYPE_ORDER[type] < TYPE_ORDER[ex.type]) tmpMap.set(canon,{label:label, type:type});
          }
        };
        const addAlias = (alias, canonLabel)=>{
          const a=normalize(alias); const c=normalize(canonLabel);
          aliasLookup.set(a, c);
        };

        data.forEach(c=>{
          const countryName = c?.name?.common || c?.name?.official;
          if(!countryName) return;
          add(countryName,'country');

          // add aliases (alt spellings + ISO codes)
          (c.altSpellings||[]).forEach(a=> addAlias(a, countryName));
          if(c.cca2) addAlias(c.cca2, countryName);
          if(c.cca3) addAlias(c.cca3, countryName);

          // capital as city
          if(Array.isArray(c.capital)){
            c.capital.forEach(cap=> add(cap,'city'));
          }

          // subregion as region when useful
          if(c.subregion) add(c.subregion,'region');
          if(c.region) add(c.region,'continent'); // keeps continent on top
        });

        allLocationOptions = [...tmpMap.values()]
          .sort((a,b)=>{
            const t = TYPE_ORDER[a.type]-TYPE_ORDER[b.type];
            if(t!==0) return t;
            return a.label.localeCompare(b.label);
          });
      }catch(_e){
        // continue with base index if fetch fails
      }
    }

    function expandQuery(query){
      const n = normalize(query);
      if(!n) return [];
      const canon = aliasLookup.get(n);
      return canon ? [n, canon] : [n];
    }

    function filterOptions(query){
      const qVars = expandQuery(query);
      if(qVars.length===0){
        const top=[];
        top.push(...allLocationOptions.filter(o=>o.type==='continent'));
        top.push(...allLocationOptions.filter(o=>o.type==='region').slice(0, 12));
        top.push(...allLocationOptions.filter(o=>o.type==='country').slice(0, 24));
        return top.slice(0, 60);
      }
      const scored=[];
      for(const o of allLocationOptions){
        const l = normalize(o.label);
        let match=false, rank=3;
        for(const q of qVars){
          if(l===q){ match=true; rank=Math.min(rank,0); break; }
          if(l.startsWith(q)){ match=true; rank=Math.min(rank,1); }
          else if(l.includes(q)){ match=true; rank=Math.min(rank,2); }
        }
        if(match) scored.push({o,rank});
      }
      scored.sort((a,b)=>{
        if(a.rank!==b.rank) return a.rank-b.rank;
        const t = TYPE_ORDER[a.o.type]-TYPE_ORDER[b.o.type];
        if(t!==0) return t;
        return a.o.label.localeCompare(b.o.label);
      });
      return scored.map(s=>s.o).slice(0, 80);
    }

    function groupByType(list){
      const groups = {continent:[], region:[], country:[], state:[], city:[], territory:[], other:[]};
      list.forEach(o=> (groups[o.type]||groups.other).push(o));
      return groups;
    }

    function renderSuggestions(query){
      const results = filterOptions(query);
      suggestionsEl.innerHTML='';
      const groups = groupByType(results);
      const order = ['continent','region','country','state','city','territory'];
      let hasAny=false;

      const headerLabel = t=>{
        switch(t){
          case 'continent': return 'Continents';
          case 'region': return 'Regions';
          case 'country': return 'Countries';
          case 'state': return 'States';
          case 'city': return 'Cities';
          case 'territory': return 'Territories';
          default: return 'Other';
        }
      };

      order.forEach(t=>{
        const arr=groups[t];
        if(!arr || !arr.length) return;
        hasAny=true;
        const header=document.createElement('div');
        header.className='suggestion-header';
        header.textContent=headerLabel(t);
        suggestionsEl.appendChild(header);
        arr.forEach(o=>{
          const item=document.createElement('div');
          item.className='suggestion-item';
          item.setAttribute('role','option');
          item.dataset.value=o.label;
          item.dataset.type=o.type;
          item.innerHTML = `${escapeHTML(o.label)} <span style="opacity:.6;font-size:12px;">‚Ä¢ ${o.type}</span>`;
          item.addEventListener('mousedown',(e)=>{ e.preventDefault(); pickSuggestion(o.label); });
          suggestionsEl.appendChild(item);
        });
      });

      if(!hasAny){
        suggestionsEl.innerHTML = `<div class="suggestion-item" aria-disabled="true">No matches‚Ä¶</div>`;
      }
      suggestionsEl.hidden=false;
      activeSuggestionIndex=-1;
    }

    // Keyboard support
    let searchTimer=null;
    let activeSuggestionIndex=-1;

    searchEl.addEventListener('input', e=>{
      clearTimeout(searchTimer);
      searchTimer=setTimeout(()=>{
        state.query=(e.target.value||'');
        renderSuggestions(state.query);
      }, 80);
    });
    searchEl.addEventListener('focus', ()=>{
      renderSuggestions(searchEl.value||'');
    });
    searchEl.addEventListener('blur', ()=>{
      setTimeout(()=> hideSuggestions(), 120);
    });
    searchEl.addEventListener('keydown', e=>{
      const items=[...suggestionsEl.querySelectorAll('.suggestion-item[role="option"]')];
      if((e.key==='ArrowDown' || e.key==='ArrowUp') && items.length){
        e.preventDefault();
        if(e.key==='ArrowDown') activeSuggestionIndex=(activeSuggestionIndex+1)%items.length;
        else activeSuggestionIndex=(activeSuggestionIndex-1+items.length)%items.length;
        items.forEach((el,idx)=> el.setAttribute('aria-selected', String(idx===activeSuggestionIndex)));
        const el=items[activeSuggestionIndex];
        if(el){ el.scrollIntoView({block:'nearest'}); }
      }else if(e.key==='Enter'){
        const val=(e.target.value||'').trim();
        if(activeSuggestionIndex>=0 && items[activeSuggestionIndex]){
          e.preventDefault();
          pickSuggestion(items[activeSuggestionIndex].dataset.value);
        }else if(val){
          applyLocationFilter(val);
        }
      }else if(e.key==='Escape'){
        hideSuggestions();
      }
    });

    function hideSuggestions(){
      suggestionsEl.hidden=true;
      suggestionsEl.innerHTML='';
      activeSuggestionIndex=-1;
    }
    function pickSuggestion(value){
      searchEl.value=value;
      hideSuggestions();
      applyLocationFilter(value);
    }

    // ===== Geocoding bounds (Nominatim) so we can zoom even with no pins
    const geoCache = new Map(); // normalized query -> L.LatLngBounds
    async function fetchGeoBounds(query){
      const key = normalize(query);
      if(geoCache.has(key)) return geoCache.get(key);
      try{
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&email=sleepyoxsin@gmail.com&q=${encodeURIComponent(query)}`;
        const res = await fetch(url, { headers: { 'Accept':'application/json' }});
        if(!res.ok) return null;
        const arr = await res.json();
        const first = Array.isArray(arr) ? arr[0] : null;
        if(!first || !first.boundingbox) return null;
        const [south, north, west, east] = first.boundingbox.map(Number);
        const bounds = L.latLngBounds([ [south, west], [north, east] ]);
        geoCache.set(key, bounds);
        return bounds;
      }catch(_e){
        return null;
      }
    }
    async function zoomToGeoBounds(query){
      const bounds = await fetchGeoBounds(query);
      if(bounds){
        // ensure map visible
        const mapEl=document.getElementById('map');
        if(mapEl.classList.contains('map-hidden')){
          mapEl.classList.remove('map-hidden');
          setTimeout(()=>{ map.invalidateSize(); map.flyToBounds(bounds, { padding:[40,40], maxZoom:7 }); }, 220);
        }else{
          map.flyToBounds(bounds, { padding:[40,40], maxZoom:7 });
        }
      }else{
        // fallback if no bounds found
        map.flyTo([25,15], 2);
      }
    }

    function applyLocationFilter(value){
      state.location = value; // keep label as typed/shown
      state._pendingSearchZoom = true;
      render();
      updateActiveFilterChips();

      // ensure map visible on mobile
      const mapEl=document.getElementById('map');
      if(mapEl.classList.contains('map-hidden')){
        mapEl.classList.remove('map-hidden');
        setTimeout(()=> map.invalidateSize(), 220);
      }

      // If the current filter produced no pins, zoom to geographic bounds
      const itemsNow = filteredItems();
      const hasAnyPins = itemsNow.some(i => Number.isFinite(i.lat) && Number.isFinite(i.lng));
      if(!hasAnyPins){
        zoomToGeoBounds(value);
      }
    }

    // Language / other controls
    const mapEl=document.getElementById('map');
    const toggleBtn=document.getElementById('toggleMapBtn');
    toggleBtn.addEventListener('click', ()=>{
      const hidden=mapEl.classList.toggle('map-hidden');
      toggleBtn.setAttribute('aria-pressed', String(!hidden));
      setTimeout(()=>{ map.invalidateSize(); }, 220);
    });
    document.getElementById('langSel').addEventListener('change', async e=>{
      state.lang=e.target.value;
      await translateAll();
    });
    document.getElementById('clearFilters').addEventListener('click', ()=>{
      state.query=''; searchEl.value='';
      state.location='';
      state.activeCats.clear(); state.activeTags.clear();
      document.querySelectorAll('#categoryGrid input[type=checkbox],#tagsGrid input[type=checkbox]').forEach(cb=>cb.checked=false);
      updateActiveFilterChips();
      hideSuggestions();
      render();
    });
    document.getElementById('reloadBtn').addEventListener('click', ()=>loadCSV(true));

    // Translation (only applied to summaries; map tiles remain English via basemap choice)
    async function translateAll(){
      if(state.lang==='en'){ render(); return; }
      const jobs=[];
      for(const item of state.data){
        if(!item._t) item._t={};
        if(item._t[state.lang]) continue;
        jobs.push((async ()=>{
          try{
            const q = encodeURIComponent(item.summary || '');
            const res=await fetch(`https://api.mymemory.translated.net/get?q=${q}&langpair=en|${state.lang}`);
            const json=await res.json();
            const txt=json?.responseData?.translatedText || item.summary || '';
            item._t[state.lang]={summary:txt};
          }catch(_err){
            item._t[state.lang]={summary:item.summary||''};
          }
        })());
      }
      await Promise.allSettled(jobs);
      render();
    }

    function getSummary(i){
      return (state.lang==='en'||!i._t?.[state.lang]) ? (i.summary||'') : (i._t[state.lang].summary||i.summary||'');
    }
    function validCoords(lat,lng){
      return Number.isFinite(lat) && Number.isFinite(lng) && Math.abs(lat)<=90 && Math.abs(lng)<=180;
    }

    // Matching logic (aliases & partials)
    function locationMatchesItem(query, i){
      if(!query) return true;
      const qNorm = normalize(query);
      const canon = aliasLookup.get(qNorm) || qNorm;
      const fields=[i.continent,i.region,i.country,i.state_name,i.city].map(v=>normalize(v));
      return fields.some(f=>{
        if(!f) return false;
        return f===canon || f.startsWith(canon) || f.includes(canon) ||
               f===qNorm || f.startsWith(qNorm) || f.includes(qNorm);
      });
    }

    // Build dropdowns
    function buildDropdowns(items){
      const allCats=new Set(), allTags=new Set();
      state.data.forEach(i=>{
        (i.categories||[]).forEach(c=> allCats.add(String(c)));
        (i.tags||[]).forEach(t=> allTags.add(String(t)));
      });

      categoryGrid.innerHTML=[...allCats].sort().map(c=>{
        const checked = state.activeCats.has(c) ? 'checked' : '';
        return `<label class='cb'><input type='checkbox' value="${escapeAttr(c)}" ${checked}>${escapeHTML(c)}</label>`;
      }).join('');

      tagsGrid.innerHTML=[...allTags].sort().map(t=>{
        const checked = state.activeTags.has(t) ? 'checked' : '';
        return `<label class='cb'><input type='checkbox' value="${escapeAttr(t)}" ${checked}>${escapeHTML(t)}</label>`;
      }).join('');

      categoryGrid.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        cb.onchange = (e)=>{
          const val=e.target.value;
          if(e.target.checked) state.activeCats.add(val); else state.activeCats.delete(val);
          render();
        };
      });
      tagsGrid.querySelectorAll('input[type=checkbox]').forEach(cb=>{
        cb.onchange = (e)=>{
          const val=e.target.value;
          if(e.target.checked) state.activeTags.add(val); else state.activeTags.delete(val);
          render();
        };
      });
    }

    // CSV loader
    const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7bipbinJbUpjJN2nG8Yr0jb6fNoO8PYxTDvIyRplRvoNQcN1oyvXgTJZ-P30pDe-OD7JJ-1odsj3J/pub?output=csv";
    async function loadCSV(isManual=false){
      try{
        statusText.textContent = isManual ? 'Reloading‚Ä¶' : 'Loading‚Ä¶';
        const res=await fetch(CSV_URL, { cache:'no-store' });
        if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
        const txt=await res.text();
        const parsed=Papa.parse(txt,{header:true,skipEmptyLines:true});
        const rows = Array.isArray(parsed?.data) ? parsed.data : [];

        state.data = rows.map(r=>{
          const lat = Number(r.lat);
          const lng = Number(r.lng);
          return {
            id: r.id ?? cryptoRandomId(),
            title: r.title ?? '',
            summary: r.summary ?? '',
            tags: splitCSV(r.tags),
            categories: splitCSV(r.categories),
            continent: (r.continent || r.continental || '').toString().trim(),
            region: (r.region || r.area || '').toString().trim(),
            country: (r.country || '').toString().trim(),
            state_name: (r.state || r.province || r.state_name || '').toString().trim(),
            city: (r.city || r.locality || '').toString().trim(),
            lat: Number.isFinite(lat) ? lat : NaN,
            lng: Number.isFinite(lng) ? lng : NaN,
            occurred_at: r.occurred_at || r.time || ''
          };
        });

        state.lastLoaded = new Date().toLocaleString(undefined, { hour12:false });
        statusText.textContent = `Last updated: ${state.lastLoaded}`;

        // (re)build indexes from fresh data then enrich
        seedAliases();
        buildBaseIndex();
        await enrichCountries(); // adds countries + capitals (cities)
        updateActiveFilterChips();
        render();
      }catch(err){
        console.error(err);
        statusText.textContent = 'Failed to load';
        feedEl.innerHTML = `<div class="error">Error loading data. Please try Reload.</div>`;
        // still provide suggestions baseline
        seedAliases();
        buildBaseIndex();
        await enrichCountries();
      }
    }

    function splitCSV(val){
      return String(val||'')
        .split(',')
        .map(s=>s.trim())
        .filter(Boolean);
    }
    function cryptoRandomId(){
      if(window.crypto?.getRandomValues){
        const arr=new Uint32Array(2); crypto.getRandomValues(arr);
        return 'id-'+arr[0].toString(16)+arr[1].toString(16);
      }
      return 'id-'+Math.random().toString(16).slice(2);
    }

    // Escapes
    function escapeHTML(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){
      return String(str).replaceAll('"','&quot;');
    }

    // Active chip (location)
    function updateActiveFilterChips(){
      const chips=[];
      if(state.location){
        chips.push(`
          <span class="filter-chip" data-key="location">
            <span>Location: ${escapeHTML(state.location)}</span>
            <button type="button" aria-label="Remove location filter">√ó</button>
          </span>
        `);
      }
      activeFiltersEl.innerHTML = chips.join('');
      const locChipBtn = activeFiltersEl.querySelector('[data-key="location"] button');
      if(locChipBtn){
        locChipBtn.addEventListener('click', ()=>{
          state.location='';
          searchEl.value='';
          render();
          updateActiveFilterChips();
        });
      }
    }

    // Region label
    function regionLabel(key){
      const map = {
        'ua_ru':'Ukraine / Russia',
        'il_ps':'Israel / Palestine',
        've':'Venezuela',
        'all':'All Regions'
      };
      return map[String(key).toLowerCase()] || key;
    }

    // Filtered items
    function filteredItems(){
      return state.data.filter(i=>{
        if(state.location && !locationMatchesItem(state.location, i)) return false;
        if(state.theme!=='all'){
          const valid=(LEGEND_GROUPS[state.theme]||[]).map(x=>x.toLowerCase());
          const has=(i.tags||[]).some(t=> valid.includes((t||'').toLowerCase()));
          if(!has) return false;
        }
        if(state.activeCats.size){
          const set=new Set((i.categories||[]).map(x=>String(x)));
          for(const c of state.activeCats){ if(!set.has(c)) return false; }
        }
        if(state.activeTags.size){
          const set=new Set((i.tags||[]).map(x=>String(x)));
          for(const t of state.activeTags){ if(!set.has(t)) return false; }
        }
        return true;
      });
    }

    // Render feed + map
    function render(){
      clusters.clearLayers();
      feedEl.innerHTML='';
      statusText.textContent = state.lastLoaded ? `Last updated: ${state.lastLoaded}` : 'Ready';

      const items = filteredItems();
      buildDropdowns(items);
      countText.textContent = items.length ? `${items.length} result${items.length===1?'':'s'}` : '';

      if(!items.length){
        feedEl.innerHTML = `<div class="empty">No results. Try a different location or clear filters.</div>`;
        if(state._pendingRegionZoom || state._pendingSearchZoom){
          const hadSearch = state._pendingSearchZoom;
          state._pendingRegionZoom=false;
          state._pendingSearchZoom=false;
          if(hadSearch && state.location){
            zoomToGeoBounds(state.location);
          }else{
            map.flyTo([25,15], 2);
          }
        }
        return;
      }

      const locLatLngs=[];
      let firstMarker=null;

      for(const i of items){
        if(validCoords(i.lat, i.lng)){
          const primary=(i.tags?.[0]||'').toLowerCase();
          const m=L.marker([i.lat,i.lng], { icon: makeIcon(primary), title: i.title||'Incident' });
          m.bindPopup(`<b>${escapeHTML(i.title||'')}</b><br>${escapeHTML(getSummary(i))}`);
          clusters.addLayer(m);
          i._marker=m;
          locLatLngs.push([i.lat,i.lng]);
          if(!firstMarker) firstMarker=m;
        }

        const card=document.createElement('div');
        card.className='card';
        const tagsHTML=(i.tags||[]).map(t=>`<span class="tagpill">${escapeHTML(t)}</span>`).join(' ');
        const locBits=[i.city,i.state_name,i.country].filter(Boolean).join(', ');
        const locPill = locBits ? `<span class="tagpill">${escapeHTML(locBits)}</span>` : '';
        card.innerHTML=`
          <h3>${escapeHTML(i.title||'Untitled')}</h3>
          <div class="meta">
            <span>${escapeHTML(i.occurred_at||'')}</span>
            ${i.region? `<span class="tagpill">${escapeHTML(regionLabel(i.region))}</span>`:''}
            ${locPill}
            ${tagsHTML}
          </div>
          <p>${escapeHTML(getSummary(i))}</p>
        `;
        card.onclick=()=>{
          if(validCoords(i.lat,i.lng)){
            if(mapEl.classList.contains('map-hidden')){
              mapEl.classList.remove('map-hidden');
              setTimeout(()=>{ map.invalidateSize(); map.flyTo([i.lat,i.lng],6); i._marker && clusters.zoomToShowLayer(i._marker, ()=>i._marker.openPopup()); }, 220);
            }else{
              map.flyTo([i.lat,i.lng],6);
              i._marker && clusters.zoomToShowLayer(i._marker, ()=>i._marker.openPopup());
            }
          }
        };
        feedEl.appendChild(card);
      }

      if(state._pendingRegionZoom || state._pendingSearchZoom){
        state._pendingRegionZoom=false;
        const hadSearch = state._pendingSearchZoom;
        state._pendingSearchZoom=false;

        if(locLatLngs.length===0){
          if(hadSearch && state.location){
            zoomToGeoBounds(state.location);
          }else{
            map.flyTo([25,15], 2);
          }
        }else if(locLatLngs.length===1){
          const p=L.latLng(locLatLngs[0][0], locLatLngs[0][1]);
          map.flyTo(p, 6);
          if(firstMarker){
            clusters.zoomToShowLayer(firstMarker, ()=>firstMarker.openPopup());
          }
        }else{
          const bounds=L.latLngBounds(locLatLngs.map(ll=>L.latLng(ll[0], ll[1])));
          if(mapEl.classList.contains('map-hidden')){
            mapEl.classList.remove('map-hidden');
            setTimeout(()=>{ map.invalidateSize(); map.flyToBounds(bounds, { padding:[40,40], maxZoom:7 }); }, 220);
          }else{
            map.flyToBounds(bounds, { padding:[40,40], maxZoom:7 });
          }
        }
      }
    }

    // Resize observer
    const ro = new ResizeObserver(()=> map.invalidateSize());
    ro.observe(document.querySelector('aside'));

    // Init baseline index immediately so suggestions appear right away
    seedAliases();
    buildBaseIndex();
    enrichCountries();

    // Initial load
    loadCSV();
  </script>
</body>
</html>
